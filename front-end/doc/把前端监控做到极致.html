<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Title</title>
        </head>
        <body>
        
                    

                    
                    
                    
                    <blockquote style="box-sizing: inherit;padding-left: 1.2em;margin-top: 20px;margin-bottom: 20px;color: rgb(51, 51, 51);border-left-width: 4px;border-left-color: rgb(226, 227, 228);">本文系第 12 届 D2 前端大会议题《把前端监控做到极致》的总结文章，你也可以直接查看现场视频<span class="" style="box-sizing: inherit;font-size: 24px;speak: none;font-feature-settings: normal;font-variant-numeric: normal;font-variant-east-asian: normal;line-height: 1;-webkit-font-smoothing: antialiased;font-family: icomoon !important;"></span>&nbsp;或&nbsp;PPT<span class="" style="box-sizing: inherit;font-size: 24px;speak: none;font-feature-settings: normal;font-variant-numeric: normal;font-variant-east-asian: normal;line-height: 1;-webkit-font-smoothing: antialiased;font-family: icomoon !important;"></span>。</blockquote><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">说到监控，大家第一时间想到的肯定是 Zabbix、Nagios 等各种强大的后端监控服务。诚然，这些强大的平台通过采集服务器以及链路上各种中间件的数据，为我们的应用稳定起到了不可或缺的保驾护航作用。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">然而在互联网的另一端，运行在用户终端上的代码却缺少这样强大的监控能力。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">对于资深工程师来说，想到或者做出一个前端监控方案并不是什么难事 —— 通过监听全局的 window.onerror 事件捕获到运行时错误，然后上报到采集端，再做一个页面展示数据 —— 看起来确实只需要写一个简单的 CRUD 应用就能搞定。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">本文将从&nbsp;<span style="box-sizing: inherit;font-weight: 600;">采集</span>、<span style="box-sizing: inherit;font-weight: 600;">数据处理</span>、<span style="box-sizing: inherit;font-weight: 600;">分析</span>、<span style="box-sizing: inherit;font-weight: 600;">报警</span>&nbsp;4 个维度进一步阐述如何把前端监控做到极致。</p><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">小福利</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">如果你还没有使用前端监控服务，那么可以先看看这个小福利。<span style="box-sizing: inherit;font-weight: 600;">只用两行代码就能打造一个前端异常实时监控平台，还带报错数统计功能。</span></p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="" data-ratio="0.21944444444444444" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRialZVXib9gLzhtmQvBibUseAibJAgRxEbNvaD5rLy6M5Cw9JrBt2qjecZbA/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: auto !important; visibility: visible !important;" width="1329" _width="677px" src="./把前端监控做到极致_files/640" crossorigin="anonymous" alt="图片" data-fail="0"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">其实现思路正如开题所言，通过&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">window.onerror</code>&nbsp;采集到所有的未捕获异常，并通过&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">new Image</code>&nbsp;的方式构造一个 404 的 HTTP 请求，最后在服务端实时过滤 access.log 中匹配的请求并计数即可。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">当然，这个监控系统并不能直接应用在生产环境。要让监控真正发挥价值，还需要从采集、处理、分析、报警等多个方面进行优化增强。</p><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">采集</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">Script Error</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">当我们采集前端报错的时候，第一个遇到的问题就是&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">Script Error</code>。Script Error 不是一种具体的错误，而是浏览器对跨域错误出于安全机制考虑的一种处理方式。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">一个前端错误为什么涉及到了「安全」问题呢？2006 年一位安全研究人员发现第三方脚本可以通过页面中报错信息的不同判断当前用户是否登录了指定的网站，并向 Webkit 项目提出了相关的 issue<span class="" style="box-sizing: inherit;font-size: 24px;speak: none;font-feature-settings: normal;font-variant-numeric: normal;font-variant-east-asian: normal;line-height: 1;-webkit-font-smoothing: antialiased;font-family: icomoon !important;"></span>。7 年之后，各大浏览器厂商基本都支持了这一安全设定。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.38055555555555554" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiahWj8OhX4XC6sRIn8wKxnm97MBDmufLYbGFXefYGIicp0e9FC3hlDo1g/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 258.875px !important;" width="1920" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"><figcaption style="box-sizing: inherit;margin-top: 16px;font-size: 14px;line-height: 1.5;text-align: center;color: rgb(153, 153, 153);">Webkit 源码中对 Script Error 的处理</figcaption></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">简单的说，如果你的页面和页面中引用的 JavaScript 文件不同源（协议、域名、端口不一致），那么这些脚本抛出的错误都属于跨域错误。那么我们在做前端监控捕获这些错误的时候，应该怎么避免采集到 Script Error 呢？</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">答案是&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">crossorigin</code>&nbsp;属性。这是一个应用在&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">&lt;script&gt;</code>&nbsp;标签上的属性，添加之后即可保证即使是跨域错误也能捕获到完整的错误信息。然而事情真的只有这么简单吗？</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">crossorigin 生效需要服务器端和浏览器端同时支持。服务器端支持比较简单，即返回跨域脚本的服务器（一般为 CDN 服务器）正确的带上 CORS 响应头 ——&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">Access-Control-Allow-Origin: *</code>&nbsp;—— 即可，目前常见的 CDN 服务均支持这一特性。而浏览器端的支持情况就没有这么乐观了。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.43194444444444446" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRia64GevWjq0A2CVZ7WmcrTkVJEdOJUND3rYEpfUEcEKbiasQiat5wacUDA/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 293.562px !important;" width="1734" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"><figcaption style="box-sizing: inherit;margin-top: 16px;font-size: 14px;line-height: 1.5;text-align: center;color: rgb(153, 153, 153);">crossorigin 属性前端支持情况</figcaption></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">可以看到，crossorigin 前端支持问题的重灾区发生在 IE 和 Safari 上。IE 这个拖油瓶出现问题是情理之中，Safari 在 9.0 之前的版本也不支持 crossorigin 就说不过去了。这也直接导致了许多运行在 iOS Webview 中的业务无法正确捕获到错误。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">突破跨域报错限制</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">那么怎样能突破 crossorigin 的这些限制，尽可能的捕获到更详细的错误呢？</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">首先最简单也是最直白的方式，就是把页面中所有的跨域资源放在跟页面同样的域下，这样脚本抛出的错误不再是跨域错误，也就不存在 crossorigin 的使用场景了。当然同域化之后也会遇到很多问题，比如无法利用 CDN 的性能、页面单域资源并发加载限制等等。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">另一种解决方案是通过 Patch 原生方法来尽可能的捕获到错误，这也是很多监控脚本默认提供的能力。比如说我们可以通<span style="background-color: rgb(255, 255, 255);color: rgb(62, 62, 62);font-size: 16px;">过如下代码来 Patch 原生的 setTimeout 方法：</span></p><pre style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 0px;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;background-color: rgb(255, 255, 255);"><code class="" style="box-sizing: border-box;padding: 0.5em;font-size: 14px;color: rgb(131, 148, 150);line-height: 18px;font-family: Consolas, Inconsolata, Courier, monospace;display: block;overflow-x: auto;letter-spacing: 0px;background: rgb(0, 43, 54);word-wrap: normal !important;word-break: normal !important;overflow-y: auto !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">const</span> prevSetTimeout = <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(220, 50, 47);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">window</span>.setTimeout;<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(220, 50, 47);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">window</span>.setTimeout = <span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">function</span>(<span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">callback, timeout</span>) </span>{<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">const</span> self = <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>;<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">return</span> prevSetTimeout(<span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">function</span>(<span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"></span>) </span>{<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">try</span> {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp; &nbsp;callback.call(<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>);<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;} <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">catch</span> (e) {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(88, 110, 117);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">// 捕获到详细的错误，在这里处理日志上报等了逻辑</span><br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(88, 110, 117);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">// ...</span><br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">throw</span> e;<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;}, timeout);<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">} <br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"></code></pre><p style="box-sizing: border-box;margin-top: 1.5em;margin-bottom: 1.5em;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;white-space: normal;background-color: rgb(255, 255, 255);">同理，我们还可以 Patch 更多的原生方法，比如Array.prototype.forEach、setInterval、requestAnimationFrame等等。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">诚然这种方法能帮我们尽可能捕获到更多异常，但是因为 Patch 了 JavaScript 原生的方法，总是感觉会存在很多的不确定性。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">在这里还要提一下去年 QCon 上百姓网前端同学刘小杰提出的一种基于 Babel 的自动添加&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">try...catch...</code>&nbsp;的方法<span class="" style="box-sizing: inherit;font-size: 24px;speak: none;font-feature-settings: normal;font-variant-numeric: normal;font-variant-east-asian: normal;line-height: 1;-webkit-font-smoothing: antialiased;font-family: icomoon !important;"></span>，感兴趣的同学可以去深入看看，会有不少启发。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">框架层解决方案</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">在不少现代前端框架中，都提供了框架层的异常处理方案，比如 AngularJS 的&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">ErrorHandler</code>&nbsp;和 Vue 的&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">Vue.config.errorHandler</code>。在这里我们以 React 16 的&nbsp;<code style="box-sizing: inherit;margin-right: 2px;margin-left: 2px;padding: 3px 4px;border-radius: 3px;">componentDidCatch</code>&nbsp;为例，说明如何使用框架的能力采集错误。</p><p style="box-sizing: border-box;margin-top: 1.5em;margin-bottom: 1.5em;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;white-space: normal;background-color: rgb(255, 255, 255);">以下是 React 官网中的示例：</p><pre style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 0px;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;background-color: rgb(255, 255, 255);"><code class="" style="box-sizing: border-box;padding: 0.5em;font-size: 14px;color: rgb(131, 148, 150);line-height: 18px;font-family: Consolas, Inconsolata, Courier, monospace;display: block;overflow-x: auto;letter-spacing: 0px;background: rgb(0, 43, 54);word-wrap: normal !important;word-break: normal !important;overflow-y: auto !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">class</span> <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(181, 137, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">ErrorBoundary</span> <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">extends</span> <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(181, 137, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">React</span>.<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(181, 137, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">Component</span> </span>{<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">constructor</span>(props) {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">super</span>(props);<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>.state = { <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(181, 137, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">hasError</span>: <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(42, 161, 152);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">false</span> };<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;componentDidCatch(error, info) {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>.setState({ <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(181, 137, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">hasError</span>: <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(42, 161, 152);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">true</span> });<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(88, 110, 117);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">// 在这里可以做异常的上报</span><br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;logErrorToMyService(error, info);<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;render() {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">if</span> (<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>.state.hasError) {<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">return</span> <span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">&lt;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(38, 139, 210);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">h1</span>&gt;</span>Something went wrong.<span class="" style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">&lt;/<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(38, 139, 210);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">h1</span>&gt;</span></span>;<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp; &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">return</span> <span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(133, 153, 0);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">this</span>.props.children;<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">}<br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"></code></pre><p style="box-sizing: border-box;margin-top: 1.5em;margin-bottom: 1.5em;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;white-space: normal;background-color: rgb(255, 255, 255);">在使用时，用 ErrorBoundary 包裹你的业务组件即可：</p><pre style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 0px;font-size: 16px;color: rgb(62, 62, 62);line-height: inherit;background-color: rgb(255, 255, 255);"><code class="" style="box-sizing: border-box;padding: 0.5em;font-size: 14px;color: rgb(131, 148, 150);line-height: 18px;font-family: Consolas, Inconsolata, Courier, monospace;display: block;overflow-x: auto;letter-spacing: 0px;background: rgb(0, 43, 54);word-wrap: normal !important;word-break: normal !important;overflow-y: auto !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(38, 139, 210);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">&lt;ErrorBoundary&gt;</span><br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"> &nbsp;<span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(38, 139, 210);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">&lt;MyWidget /&gt;</span><br style="box-sizing: border-box;font-size: inherit;color: inherit;line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;"><span class="" style="box-sizing: border-box;font-size: inherit;color: rgb(38, 139, 210);line-height: inherit;word-wrap: inherit !important;word-break: inherit !important;white-space: inherit !important;">&lt;/ErrorBoundary&gt;</span></code></pre><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">数据处理</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">传统的监控服务一般都会使用 MySQL 等数据库进行数据持久化，但当数据量指数级增长时，MySQL 这种 OLTP 数据库已经不再适合用来提供监控数据分析服务。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">在大数据时代，搭建一套标准化的、针对监控业务的大数据解决方案已经不是什么难事，下图即为一个简单的数据架构示意图：</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.5291666666666667" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiaau5HRM1RkDkTvsm4zgEac1Hvic9yu2rk9YKQDicpKYm9LLOU444kI8Hg/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 359.188px !important;" width="1244" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">在数据处理过程中，值得一提的是数据采样率的功能设计。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.4986111111111111" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiah2Q0zUOXGJIaiafEYr0LTHaoOfevbljiauHX361h8HUQwicnib8lr4QPJw/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 338.562px !important;" width="1234" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">不难看出目前的采样率设计方案都或多或少存在缺陷和妥协，那么有没有一种更优的解决方案呢？</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.5277777777777778" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiawIDcrMiadoxOtDBAujvCCMUpGxpYpOQkEgUUssicMIaiaEYrSib9qPoayg/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 358.25px !important;" width="753" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">经过大量的实践后，我们认为在日志服务进入数据处理流程之前进行采样率控制是比较理想的方案，理由如下：</p><ol style="" class="list-paddingleft-2"><li><p>日志写入成本低</p></li><li><p>rotate 机制保证存储不会浪费</p></li><li><p>了解真实打点请求数据量</p></li><li><p>避免采集端绕过采样率限制</p></li></ol><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">分析</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">当故障发生时</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">解决了数据采集和处理的问题，我们应该怎么着手进行分析呢？让我们先看一个真实案例：</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">当你吃着火锅唱着歌的时候，突然看到实时监控数据暴涨，这个时候你的第一反应是什么呢？是不是手足无措不知道应该怎么处理？当线上出现紧急状况时，我们的首要思路是找到问题触发的特征，比如是否集在某个页面或者某种浏览器等等。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">通过监控平台提供的分析功能，初步定为到问题原因后，再进行深入的调查。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">报错数高一定是不稳定吗</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">这里试举两个反例来说明报错数高不一定就是前端不稳定。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.6527777777777778" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiaXGicQZdgRibsz44kxKeVgnicyickgoibHDyvLNUicA9hmZLxXUHxtBqm8ULA/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 442.625px !important;" width="1280" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">如上图所示，虽然该应用 1 天爆出了上万的 JavaScript 异常，但是我们在分析过程中发现，95% 的报错都集中在 3 个 userId 上。再对这 3 个 userId 进行深入的调查不难发现，这是 3 个爬取数据的爬虫账号，不巧爬数据的脚本写的有 Bug，被前端监控系统忠实的捕捉到了。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.4125" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRia0FXecroAD5VibicKLVPIupJO4Jcib2klgKx7tvqfRhBYTWELjUa2fibA7A/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 280.438px !important;" width="1768" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">又如上图所示，某天的数据出现暴增，可能是因为页面的访问量出现暴增。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">因此我们不难发现，仅仅通过报错数的多少不足以判断系统是否稳定。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><span style="box-sizing: inherit;font-weight: 600;">异常波动一定有元凶</span></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">前端发生故障最常见的原因就是新发布的版本存在 Bug，那么这种问题在监控平台中如何提供分析思路呢？</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.42083333333333334" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiaJQ35OqAvvicrmkjibFPI3P23R2ZEJpeWgmlEFicXHYgDViaFXP3PZ9G8UA/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 286.062px !important;" width="1822" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><br style="box-sizing: inherit;"></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">当然，也并不是所有的波动都是前端变更引起。比如说后端接口突然故障，也会导致前端因为无法读取到某个接口结果而报错。</p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.3236111111111111" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRiaryI7kGARgTJMqed0k5A9oSNEHOfEyZWnzVFjIiafj8jhUBvcfHx6uibg/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 220.438px !important;" width="1778" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">报警</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">说到报警，绝大多数的监控平台都提供规则报警的能力。然而规则报警最大的问题在于随着业务的不断发展，原本配置的规则将会出现阈值过低或过高的问题。若阈值配置过低，则会产生大量的误报警，继而引起整个监控能力的报警疲劳。</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">为了解决规则报警的问题，监控平台可以引入一些简单的数学模型来解决时序数据的异常识别工作。以最常见的高斯分布（正态分布）为例，利用 3-sigma 原则可以快速判断某一时刻的报错数是否满足概率分布，继而可以产生报警：</p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><br style="box-sizing: inherit;"></p><p><br></p><figure style="box-sizing: inherit;margin-top: 24px;margin-bottom: 24px;color: rgb(51, 51, 51);"><img class="img_loading" data-ratio="0.5013888888888889" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/1NOXMW586uvGqKpQDr4WpFHcPRPAibMRia93jY3skIKJWXp3ZY6TALKiboOic91iaO2CNeE7Sa1ia47aiaJ7QKZuiauicOQ/0?wx_fmt=jpeg" data-type="jpeg" data-w="720" style="box-sizing: inherit; overflow: hidden; display: block; max-width: 40%; margin-right: auto; margin-left: auto; cursor: -webkit-zoom-in; width: 677px !important; height: 340.438px !important;" width="1374" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></figure><p><br></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);"><br style="box-sizing: inherit;"></p><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">当然，这样的报警模型还存在非常大的优化空间，比如对数据周期性、季节性的处理，又比如过滤掉某些可能影响平均数的极高值等。</p><h2 style="box-sizing: inherit;margin-top: 20px;margin-bottom: 20px;font-variant-numeric: inherit;font-variant-east-asian: inherit;font-stretch: inherit;font-size: 24px;line-height: inherit;">结语</h2><p style="box-sizing: inherit;margin-bottom: 20px;color: rgb(51, 51, 51);">前端监控看似简单，但想要监控真正发挥价值，还需要从各个方面进行不断的优化和打磨。当然，最重要的是，要意识到前端监控的必要性，及早开始进行监控，才能更好的避免线上故障的产生。</p><p>作者: 杨森</p><p>原文链接:https://zhuanlan.zhihu.com/p/32262716</p>
                
        </body>
        </html>